<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Cadastro de expositores CMB</title>
  <meta name="description" content="Faça seu cadastro como expositor para o CMB.">

  <!-- Open Graph (WhatsApp/Facebook) -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Comic Market Brasil">
  <meta property="og:title" content="Cadastro de expositores CMB">
  <meta property="og:description" content="Faça seu cadastro de expositor para o CMB.">
  <meta property="og:url" content="https://automacaopostcmb-bit.github.io/CadastroCMB/index.html">
  <meta property="og:image" content="https://automacaopostcmb-bit.github.io/CadastroCMB/assets/og-index.jpg?v=4">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">

  <!-- Favicons -->
  <link rel="icon" type="image/png" href="https://automacaopostcmb-bit.github.io/CadastroCMB/assets/favicon.png?v=3" sizes="32x32">
  <link rel="apple-touch-icon" href="https://automacaopostcmb-bit.github.io/CadastroCMB/assets/apple-touch-icon.png?v=3" sizes="180x180">
  <link rel="shortcut icon" href="https://automacaopostcmb-bit.github.io/CadastroCMB/assets/favicon.ico?v=3">
  <meta name="theme-color" content="#0286ff">

  <!-- CSS global -->
  <link rel="stylesheet" href="style.css?v=52">

  <style>
    html, body { height: 100%; }
    body { margin: 0; }
  </style>
</head>
<body>
  <div class="page-center" style="--center-offset: -60px;">
    <img src="assets/logo-cmb.png" alt="Comic Market Brasil" class="header-logo">

    <h2 id="tituloLogin">Login</h2>

    <div id="login-area">
      <input type="text" id="chave" placeholder="Digite sua chave de acesso" />
      <button id="btnEntrar" onclick="login()">Entrar</button>
    </div>

    <!-- Menu (preenchido via JS) -->
    <div id="menu" style="display:none;">
      <h3>Páginas disponíveis</h3>
      <div id="botoes"></div>
      <p id="linkSair" onclick="logout()" style="cursor:pointer; color:#007bff; text-align:center; font-size:14px; margin-top:16px;">Sair</p>
    </div>
  </div>

  <!-- Overlay de loading -->
  <div id="loading">
    <div class="loading-bubble">Carregando páginas…</div>
  </div>

  <script>
  // Endpoint do seu Apps Script de auth/menu
  const API_URL = "https://script.google.com/macros/s/AKfycbyMbkkFdzYC_BfMsi5WKW6xbOKdjbNbW635vovOLYHGXdso2S_1a2Wdfvur790y0BM46g/exec";

  // Definição das páginas do menu
  const paginas = [
    { nome: "area_artista",         label: "Área dos Artistas", href: "artistas.html" },
    { nome: "expo_business",       label: "Expositor Área Business", href: "expo_business.html" },
    { nome: "expo_market",         label: "Expositor Área Market",   href: "expo_market.html" },
    { nome: "cadastro_masterclass",label: "Cadastro Masterclass",     href: "cadastro_masterclass.html" },
    { nome: "cadastro_lancamento", label: "Cadastro de Lançamento",   href: "cadastro_lancamento.html" },
  ];

  let isLoading = false;

  function setLoading(state) {
    isLoading = state;
    const btn = document.getElementById("btnEntrar");
    if (btn) {
      btn.disabled = state;
      btn.textContent = state ? "Carregando..." : "Entrar";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const isBack = params.get("back") === "1";
    const chave = (localStorage.getItem("chave") || "").trim();

    if (isBack && chave) {
      document.getElementById("tituloLogin").style.display = "none";
      document.getElementById("login-area").style.display = "none";
      carregarMenu();
    } else {
      localStorage.removeItem("chave");
      document.getElementById("menu").style.display = "none";
      document.getElementById("botoes").innerHTML = "";
      document.getElementById("chave").addEventListener("keydown", (e) => {
        if (e.key === "Enter") login();
      });
    }
  });

  function login() {
    const chave = document.getElementById("chave").value.trim();
    if (!chave) return alert("Digite sua chave.");
    localStorage.setItem("chave", chave);
    carregarMenu();
  }

  function logout() {
    localStorage.removeItem("chave");
    setLoading(false);
    document.getElementById("menu").style.display = "none";
    document.getElementById("botoes").innerHTML = "";
    document.getElementById("chave").value = "";
    document.getElementById("tituloLogin").style.display = "block";
    document.getElementById("login-area").style.display = "block";
    if (window.location.search.includes("back=1")) {
      window.history.replaceState({}, "", "index.html");
    }
  }

  async function carregarMenu() {
    if (isLoading) return;
    const chave = localStorage.getItem("chave");
    if (!chave) return;

    setLoading(true);

    const titulo  = document.getElementById("tituloLogin");
    const loginAr = document.getElementById("login-area");
    const menu    = document.getElementById("menu");
    const area    = document.getElementById("botoes");
    const loading = document.getElementById("loading");

    // só loading na tela
    titulo.style.display  = "none";
    loginAr.style.display = "none";
    menu.style.display    = "none";
    loading.style.display = "grid";

    let algumPermitido = false;

    try {
      // Chama o backend pedindo o "menu" (com cache-buster)
      const resp = await fetch(`${API_URL}?chave=${encodeURIComponent(chave)}&menu=1&v=${Date.now()}`);
      const data = await resp.json();

      // Aceita dois formatos: {permissoes:{...}} OU {paginas:{...}}
      let perms = data.permissoes || data.paginas || {};

      // Normaliza: se vier "expo_artistas", espelha em "areaartista"
      if (typeof perms.expo_artistas !== "undefined" && typeof perms.areaartista === "undefined") {
        perms.areaartista = !!perms.expo_artistas;
      }

      area.innerHTML = "";

      paginas.forEach((pag) => {
        if (perms[pag.nome]) {
          algumPermitido = true;
          const btn = document.createElement("button");
          btn.textContent = pag.label;
          btn.addEventListener("click", () => {
            window.location.href = pag.href || `${pag.nome}.html`;
          });
          area.appendChild(btn);
        }
      });

    } catch (err) {
      console.error(err);
      alert("Erro ao carregar. Tente novamente.");
      logout();
      return;
    } finally {
      loading.style.display = "none";
      setLoading(false);
    }

    if (algumPermitido) {
      menu.style.display = "block";
    } else {
      alert("Acesso inválido.");
      logout();
    }
  }
  </script>

  <script>
    // mede a altura real útil da janela e salva em --vh
    function setRealVh() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setRealVh();
    window.addEventListener('resize', setRealVh);
    window.addEventListener('orientationchange', setRealVh);
  </script>

  <footer class="site-footer">
    <div class="footer-inner">
      <strong>Criado por Bruno Lima • </strong>
      <a href="mailto:limasketch@gmail.com">Implemente no seu evento.</a>
      <small>© 2025 Automatic Post. Todos os direitos reservados.</small>
    </div>
  </footer>
</body>
</html>

